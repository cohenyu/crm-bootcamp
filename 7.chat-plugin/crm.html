<!DOCTYPE html>
<html>
  <head>
    <title>Socket.IO chat</title>
    <style>
      body {height: 95vh; margin: 0; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; display: flex; flex-direction: row; overflow-x: hidden; padding: 14px; background: #f3f3f3;}
      #form { 
        height: 3rem; 
        background: rgba(0, 0, 0, 0.15); 
        padding: 0.25rem; 
        display: flex; 
        box-sizing: border-box; 
        backdrop-filter: blur(10px); 
        border-bottom-right-radius: 8px;
        border-bottom-left-radius: 8px;
        display: none;
      }
      #input { border: none; padding: 0 1rem; flex-grow: 1; border-radius: 2rem; margin: 0.25rem; }
      #input:focus { outline: none; }
      #form > button { background: #333; border: none; padding: 0 1rem; margin: 0.25rem; border-radius: 3px; outline: none; color: #fff; }
      #chat-bottom {height: 5rem; width: 100%; display: flex; flex-direction: column; justify-content: flex-end; bottom: 0; position: absolute;}
      #messages { overflow: scroll; list-style-type: none; margin: 0; padding: 0; padding-bottom: 68px;}
      #messages > li { padding: 0.5rem 1rem; overflow-wrap: break-word; }
      #msg-box{
        font-size: 15px;
        color: gray;
        padding: 5px 10px;
        height: 18px;
      }
      #bottom {
        flex: 2;
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: space-between;
        position: relative;
        background: white;
        border-radius: 8px;
      }
      #room-container{
        overflow: scroll;
        width: 30%;
        background: white;
        margin-right: 9px;
        padding: 10px;
        border-radius: 8px;
      }
      #rooms > li {
        overflow-wrap: break-word;
        padding: 10px 8px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        cursor: pointer;
      }

      #rooms{
        margin: 0;
        padding: 0;
        list-style: none;
        margin-top: 15px;
      }

      #rooms > li:hover {
        background-color: #fbfbfb !important;
      }

      #rooms > li:focus {
        /* background: rgb(243, 243, 243);
        box-shadow: rgb(0 0 0 / 16%) 0px 1px 4px; */
      }

      .title {
        font-size: 20px;
      }

      .client-mail {
        font-size: 11px;
        font-weight: 300;
        color: #000000b5;
      }

      .client-name {
        display: block;
      }

      .unread {
        height: 10px;
        width: 10px;
        border-radius: 50%;
        background: #f55f55;
      }

      
    </style>
  </head>
  <body>
    <div id='room-container'>
      <span class='title'>Clients</span>
      <ul id="rooms"></ul>
    </div>
    <div id='bottom'>
    <ul id="messages"></ul>
    <div id='chat-bottom'>
      <span id='msg-box'></span>
    <form id="form" action="">
      <input id="input" autocomplete="off" />
      <button>Send</button>
    </form>
    </div>
  </div>
    <script src="/socket.io/socket.io.js"></script>
    <script>


function showCurrentRoomMsg(){
        messages.innerHTML = '';
        for(let msgData of roomsData[currentMailRoom].msgs){
          if(msgData.client){
            createClientMsg(msgData.msg, msgData.datetime);
          } else {
            createCrmMsg(msgData.msg, msgData.datetime);
          }
        }
        messages.scroll(0 , 20000);
      }
  
  function showRoom(room, name, mail, read){
    var item = document.createElement("li");
    item.tabIndex = '1';
    item.data = {room: room, name: name, mail: mail}
    item.innerHTML = `<div>
                    <span class='client-name'>${name}</span>
                    <span class='client-mail'>${mail}</span>
                    </div>
                    <div class='unread'></div>`;
    
    if(read){
      item.lastChild.style.display = 'none';
    } else  {
      item.firstChild.style.fontWeight = 'bold';
    }
    
    item.addEventListener('click', async function(e){
      if(room != currentRoom){
        roomsList = rooms.children;
        currentRoom = room;
        room = room;
        currentMailRoom = mail;
        for(let li of roomsList){
          li.style.background =  'none';
          li.style.boxShadow =  'none';
        };
        item.firstChild.style.fontWeight = '400';
        item.lastChild.style.display = 'none';
        item.style.background =  'rgb(243, 243, 243)';
        item.style.boxShadow =  'rgb(0 0 0 / 16%) 0px 1px 4px';
        showCurrentRoomMsg();
        form.style.display = "flex";
        socket.emit("room clicked", {mail: currentMailRoom, msgs: roomsData[currentMailRoom].msgs.length > 1});
      }
    })
    rooms.appendChild(item);
  }

  function createClientMsg(msg, date){
    var item = document.createElement("li");
          item.innerHTML = `<span>${msg}</span><span>${date}</span>`;
          item.style.margin = '5px';
          item.style.marginLeft = '16%';
          item.style.background = 'rgb(79 122 181 / 41%)';
          item.style.borderRadius = '12px';
          messages.appendChild(item);
    messages.scroll(0 , 2000);
  }

  function createCrmMsg(msg, date){
    var item = document.createElement("li");
        item.innerHTML = `<span>${msg}</span><span>${date}</span>`;
        item.style.margin = '5px';
        item.style.marginRight = '16%';
        item.style.border = 'solid 1px #b7c8e1';
        item.style.borderRadius = '12px';
        messages.appendChild(item);
        messages.scroll(0 , 2000);
  }

const socket = io();
      socket.emit("create crm room", "crm");
      let room = "";
      let messages = document.getElementById("messages");
      let rooms = document.getElementById("rooms");
      let form = document.getElementById("form");
      let input = document.getElementById("input");
      var msgBox = document.getElementById('msg-box');
      var timeout = undefined;
      let roomsData = {};
      let currentRoom;
      let currentMailRoom;

      form.addEventListener("submit", function (e) {
        e.preventDefault();
        if (input.value) {
          socket.emit("crm message", {
            room: room,
            from: "crm",
            msgValue: input.value,
            datetime: new Date(),
            mail: currentMailRoom
          });
          input.value = "";
        }
      });

      socket.on('rooms list', function(data){
        data.forEach(item => {
          roomsData[item.mail] = {name: item.name, mail: item.mail, room: item.roomID, read: item.read, msgs: [], created: true};
          showRoom(item.roomID, item.name, item.mail, item.read);
        });
      })

      socket.on('room msgs', function(data){
        console.log("printing the msgs");
        if(data.msgs){
          roomsData[data.room].msgs = data.msgs;
          data.msgs.forEach(msg => {
            if(msg.client){
              createClientMsg(msg.msg, msg.datetime)
            } else {
              createCrmMsg(msg.msg, msg.datetime);
            }
          });
        }
      
      });

      socket.on("new room", function (data) {
        room = data.room;
        socket.emit("join", data.room); 
        if(!roomsData[data.mail]){
          console.log("creating new room");
          roomsData[data.mail] = {name: data.name, mail: data.mail, room: data.room, read: false, msgs: []};
        } else {
          roomsData[data.mail].room = data.room;
        }
      });

      socket.on("crm message", function (msg) {
        console.log("got a msg!!!!!!");
        console.log("crm msg: ", msg);
        roomsData[msg.mail].msgs.push({msg: msg.msgValue, client: false, datetime: msg.datetime});
        createCrmMsg(msg.msgValue, msg.datetime);
        // window.scrollTo(0, document.body.scrollHeight);
      });

      socket.on("client message", function (msg) {
        console.log("got a msg!!!!!!");

        if(!roomsData[msg.mail].created){
          if(!roomsData[msg.mail].msgs.length){
            showRoom(msg.room, roomsData[msg.mail].name, msg.mail, false);
            roomsData[msg.mail].created = false;
          } else {
            roomsData[msg.mail].msgs.push({msg: msg.msgValue, client: true, datetime: msg.datetime, room: msg.room});
          }
        } else {
          roomsData[msg.mail].msgs.push({msg: msg.msgValue, client: true, datetime: msg.datetime, room: msg.room});
        }


        if(currentRoom == msg.room){
          room = msg.room;
          createClientMsg(msg.msgValue, msg.datetime)
        }  else {
          console.log("searching for the client");
          roomsList = rooms.children;
          for(let li of roomsList){
            if(li.data.mail == msg.mail){
              rooms.removeChild(li);
              rooms.insertBefore(li, rooms.firstChild);
              li.firstChild.style.fontWeight = 'bold';
              li.lastChild.style.display = 'flex';
            }
          }
          socket.emit("unread msg", room);
        }
      
      });

      input.addEventListener('keyup', ()=>{
        console.log("typing in room: ", room);
          socket.emit("crm typing", {
            isTyping: input.value.length > 0,
            room: room
          });
          clearTimeout(timeout);
          timeout = setTimeout(()=>{
            socket.emit("crm typing", {
            isTyping: false,
            room: room
          });
          }, 1000)
      })


        socket.on("client typing", function (data) {
          if(data.room == currentRoom){
            const { isTyping} = data;

            if (!isTyping) {
                msgBox.innerHTML = "";
                return;
            }
            msgBox.innerHTML = 'typing...';
            
          }
        });
        




    </script>
  </body>
</html>


